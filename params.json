{"name":"How to Use GitHub OAuth Authorization in a Google App Engine Python Application","tagline":"","body":"The GitHub API allows applications to interface with it to access GitHub user data, create/delete users, view repos and more. To access user data from the GitHub API, your app must first have authorization. This tutorial will walk you through the steps of creating a simple Google App Engine(GAE) app which will gain authorization to interface user data from GitHub. The goal here is to get an **access_token** from GitHub which can then be used to make authorized requests.\r\n \r\nThough this tutorial uses GAE for a quick Python application setup, other Python web application frameworks should be similar.  For this tutorial you must also have a GitHub account where your new application can be registered.\r\n\r\n## Creating a Python Application using Google App Engine\r\n\r\n1. Before you can get started, you will need to [download the Python SDK for App Engine.](https://cloud.google.com/appengine/downloads#Google_App_Engine_SDK_for_Python)\r\n\r\n1. In your terminal, create a new directory to hold the project called oauth-tutorial.    \r\n`mkdir oauth-tutorial`\r\n\r\n1. Inside your new directory, create a new Python file to contain your handlers. Let’s first start with a simple handler to see that the application was setup correctly. Call the file **oauth-tutorial.py** \r\n    \r\n     ```python\r\nimport webapp2\r\n\r\n\tclass MainPage(webapp2.RequestHandler):\r\n\t    def get(self):\r\n\t    \tself.reponse.headers['Content-Type'] = 'text/plain'\r\n\t    \tself.response.write('Success!')\r\n\r\n\tapp = webapp2.WSGIApplication([\r\n\t    ('/', MainPage),\r\n\t    ('/callback', Callback),\r\n\t], debug=True)\r\n    ```    \r\nThis script will response to a request with an HTTP header message “Success!”\r\n\r\n1. Next before we can run the application we need to create a configuration file called **app.yaml**. Make sure to create this inside the oauth-tutorial directory.\r\n\r\n    ```\r\nversion: 1\r\nruntime: python27\r\napi_version: 1\r\nthreadsafe: true\r\n\r\nlibraries:\r\n- name: webapp2\r\n  version: latest\r\n\r\nhandlers:\r\n- url: /.*\r\n  script: oauth-tutorial.app\r\n    ```\r\nThe syntax of this file is YAML. This file states the application version number, the python runtime environment with it’s API version and that the application is threadsafe so it can handle multiple requests at once. \r\n\r\n1. Now that there is a handler script and configuration file, the application can now be run on the web server provided by the App Engine Python SDK.  \r\n\r\n  From your directory that contains your oauth-tutorial/ directory, run this command which gets your web server running:\r\n`dev_appserver.py oauth-tutorial/`  \r\n\r\n  Then, from your browser, navigate to:\r\n[http://localhost:8080/](http://localhost:8080/)  \r\n\r\n  You should see the “Success!” message from the python file. This means everything is running correctly. \r\n\r\n## Register the application with GitHub\r\n\r\nTo have an application interface with the GitHub API, the application first needs to be registered with GitHub for them to identify where the requests for authorization are coming from. GitHub identifies applications with a **client_id** and **client_secret** it assigns uniquely to each application.  \r\n\r\nTo register your application:\r\n\r\n1. Open the form to register a new application [here](https://github.com/settings/applications/new).  \r\n\r\n  This brings you to the form to register your app.  \r\n![](http://i.imgur.com/aUkxWwt.png)\r\n\r\n1. For your **Application name**, enter what you would like your application to called, this does not need to be unique, this is the name the user will see when granting you the authorization. I named mine “GitHub OAuth Tutorial”\r\n\r\n1. For your **Homepage URL**, right now we are still running our web server locally so enter: `http://localhost:8080\r\n`  \r\n\r\n  This can be changed later if you choose to host your application.\r\n\r\n1. The **Application description** is an optional field you can use to provide further details about your application. Let’s skip that field for now.\r\n\r\n1. The **Authorization callback URL** is the last field, this is the URL that the GitHub API will send it’s requests to back our application. We will need to create a handler in our **oauth-tutorial.py** file to handle these responses. Let’s call this /callback, so for this field enter: `http://localhost:8080/callback`\r\n\r\n1. Click the **Register Application** button and now your app is registered to talk to GitHub! You should see a Client ID and Client Secret.\r\n\r\n## Getting the GitHub Authorization\r\n\r\nNow that the application is registered, we need to put our new **client_id** and **client_secret** into our application to use in requests to GitHub. But we do not want these values in code that could be pushed up to GitHub, else other applications can use them to access our users data. So one way to hide these values is to put them in a json file that will not be committed to GitHub.\r\n\r\n1. Create a new json file in your oauth-tutorial directory, called **client_secrets.json**. Inside of it, put in your **client_id** and **client_secret** you got from registering your application.\r\n\r\n    ```\r\n{\r\n    \"client_id\":\"<your client_id>\",\r\n    \"client_secret\":\"<your client_secret\"\r\n}\r\n    ```  \r\n\r\n1. Now we need to have our **oauth-tutorial.py** access these fields. To parse the json, we need to add the json library to our application. Add this as an import next to webapps:  \r\n`import webapp2, json`\r\n\r\n1. Next we can add in the code to grab those two fields. Under your imports, add:\r\n\r\n    ```python\r\nwith open('client_secrets.json') as data_file:    \r\n    data = json.load(data_file)\r\n\r\nclient_id= data[\"client_id\"]\r\nclient_secret= data[\"client_secret\"]\r\n    ```\r\n\r\n1. The next step to getting authorization to a user’s data is to have the user give permission for our app to read their data.  \r\n\r\n  We can choose to ask the user for a specific type of access such as for their profile info or gists. This is specified using scopes. See all the scopes the API supports [here](https://developer.github.com/v3/oauth/#scopes).  \r\n\r\n  For our example, let’s just get the user’s email addresses. So we will set our **scope** to `user:email`.  \r\n\r\n  Let’s put a link on our main webpage to GitHub, where to user can choose to authorize our app to read their email addresses.  \r\n\r\n  Change your get method in the MainPage class to:\r\n\r\n    ```python\r\nclass MainPage(webapp2.RequestHandler):\r\n    def get(self):\r\n        self.response.write(MAIN_PAGE_HTML)\r\n    ```\r\n\r\n1. Next create the **MAIN_PAGE_HTML** variable under your json parsing code to hold the HTML.\r\n\r\n    ```python\r\n\r\nMAIN_PAGE_HTML = \"\"\"\\\r\n<html>\r\n  <head>\r\n  </head>\r\n  <body>\r\n    <p>\r\n      You can include a link or access point in your site that brings the user to GitHub to authorize\r\n      your app to access their protected GitHub profile data. <br></br>\r\n\r\n      Here is an example:<br>\r\n\r\n      To authorize this site to access your GitHub email addresses \r\n      <a href=\"https://github.com/login/oauth/authorize?scope=user:email&client_id=%s\">Click here</a></a>\r\n    </p>\r\n  </body>\r\n</html>\r\n\"\"\" %(client_id)\r\n    ```\r\n\r\n  This will create a link that brings the user to GitHub to authorize the app to access their GitHub email. \r\n \r\n  ![](http://i.imgur.com/W0NxPjO.png)  \r\n\r\n  If the users click **Authorize application**, then Github will call our callback URL (that we stated when we registered the app). But we need setup a handler for `/callback`.\r\n\r\n1. Add a `/callback handler` after the default handler at the bottom of the page that will call a class named `Callback`\r\n\r\n    ```python\r\napp = webapp2.WSGIApplication([\r\n    ('/', MainPage),\r\n    ('/callback', Callback),\r\n], debug=True)\r\n    ```\r\n\r\n1. Now create the `Callback` class, after the `MainPage` class.  In it we will need `def get(self):` method to handle the the GET request we will get from GitHub which includes a `code` field and the `scope` for the type of access.  \r\n\r\n  Let’s create the get method and get the `scope` and `code` field from the request:\r\n\r\n   ```python\r\nclass Callback(webapp2.RequestHandler):\r\n\tdef get(self):\r\n\t\t# From the GET response from GitHub you grab the code and scope\r\n\t\tcode = self.request.get('code')\r\n\t\tscope = self.request.get('scope')\r\n    ```\r\n\r\n1. Now with this code, we have all the fields we need to construct a request for an **access_token** from GitHub! The **access_token** will then allow you to make requests to the API on behalf of the user. Now we need to put all of our fields together and contruct our request to get the **access_token**. Let’s create a dictionary of the fields, put this after the previous line:\r\n\r\n    ```python\r\nauth_params = dict(client_id=client_id, client_secret=client_secret, code=code, scope=scope)\r\n    ```\r\n1. Next we need to construct our request to the API. Add these lines right after the previous:\r\n\r\n    ```python\r\nopener = build_opener(HTTPSHandler)\r\nrequest = Request('https://github.com/login/oauth/access_token',data=_encode_params(auth_params))\r\n    ```  \r\n\r\n  This is where we build our request, before we make. Note the `_encode_params` method here, we need to take our dictionary and encode it for the request. Copy this method above your two existing classes:\r\n\r\n    ```python\r\ndef _encode_params(kw):\r\n    '''\r\n    Encode parameters using utf-8 and join them together\r\n    '''\r\n    args = []\r\n    for k, v in kw.items():\r\n        try:\r\n            qv = v.encode('utf-8') if isinstance(v, unicode) else str(v)\r\n        except:\r\n            qv = v\r\n        args.append('%s=%s' % (k, urlquote(qv)))\r\n    return '&'.join(args)\r\n    ```\r\n\r\n1. This will require importing some libraries. Let’s add all the libraries we will need:\r\n\r\n    ```python\r\nimport webapp2\r\nimport re, os, time, base64, hashlib, urllib, json\r\n\r\nfrom urllib2 import build_opener, HTTPSHandler, Request, HTTPError\r\nfrom urllib import quote as urlquote\r\n    ```  \r\n\r\n  Some of these we aren’t using yet but we will in the next steps.\r\n\r\n1. Now we can make a request for the access token. Add this code to make a request:\r\n\r\n    ```python\r\ntry:\r\n\t\t    response = opener.open(request, timeout=TIMEOUT)\r\n\t\t    access_token_response = response.read()\r\n\t\t    if 'error' in access_token_response:\r\n\t\t        raise ApiAuthError(str(access_token_response.error))\r\n\t\t    # Now you have your access_token in access_token_response!    \r\n\t\t    self.response.write(\"<p>Success! access_token received</p>\")\r\n\t\texcept HTTPError as e:\r\n\t\t    raise GitHubApiAuthError('HTTPError when getting access token from GitHub')\r\n    ```  \r\n\r\n  Everything hopefully should have worked well, but we need to do some error handling to make sure. If our try did not work, then we constructed the request incorrectly and we will get an `HTTPError`. Else this code will get the response from the request. In the next line we will read the response, which should look like:  \r\n\r\n    `access_token=e72e16c7e42f292c6912e7710c838347ae178b4a&scope=user%2Cgist&token_type=bearer`  \r\n\r\n  The next line will see if there is an error in the response, if there is it will show the error. Else, we succeeded in getting our access token and a success message will print out.\r\n\r\n1. Before you run this to get your **access_token**, we need to put in the classes for the errors mentioned above. Copy these classes after your `CallBack` class:\r\n\r\n    ```python\r\nclass ApiError(Exception):\r\n    def __init__(self, url, request, response):\r\n        super(ApiError, self).__init__(url)\r\n        self.request = request\r\n        self.response = response\r\n\r\nclass GitHubApiAuthError(ApiError):\r\n    def __init__(self, msg):\r\n        super(ApiAuthError, self).__init__(msg, None, None)\r\n    ```\r\n\r\n1. Now you should be able to run the code by refreshing your [http://localhost:8080](http://localhost:8080) page.  \r\n\r\n  With this **access_token**, you can now make authorized requests to GitHub! There are multiple [libraries](https://developer.github.com/libraries/) in several languages available to make the requests with.  \r\n\r\n  I hope this helped you to understand more about using OAuth with GitHub. If you have any issues, you can compare to my code [here](https://github.com/angelaLazar/oauth-tutorial).\r\n\r\n### Reference Links:  \r\n\r\n[GitHub API Reference](https://developer.github.com/v3/)  \r\n[OAuth Reference](https://developer.github.com/v3/oauth/)  \r\n[Google App Engine](https://cloud.google.com/appengine/docs)\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n    ","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}